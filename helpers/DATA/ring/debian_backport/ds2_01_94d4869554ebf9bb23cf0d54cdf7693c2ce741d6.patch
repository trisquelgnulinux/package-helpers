From 94d4869554ebf9bb23cf0d54cdf7693c2ce741d6 Mon Sep 17 00:00:00 2001
From: Amin Bandali <bandali@gnu.org>
Date: Sat, 25 Feb 2023 12:23:01 -0500
Subject: [PATCH] Build without Qt WebEngine on all architectures

---
 debian/control                  |  8 +-------
 debian/copyright                | 11 +++++++++++
 debian/rules                    | 11 +----------
 debian/source/lintian-overrides |  3 ---
 4 files changed, 13 insertions(+), 20 deletions(-)

#diff --git a/debian/control b/debian/control
#index dda52abc..9d8b2f0f 100644
#--- a/debian/control
#+++ b/debian/control
@@ -32,8 +32,6 @@
                qml6-module-qtquick-shapes,
                qml6-module-qtquick-templates,
                qml6-module-qtquick-window,
-               qml6-module-qtwebengine [amd64 arm64 armhf i386],
-               qml6-module-qtwebchannel [amd64 arm64 armhf i386],
                qt6-base-dev,
                qt6-declarative-dev,
                qt6-l10n-tools,
@@ -41,8 +39,6 @@
                qt6-positioning-dev,
                qt6-tools-dev,
                qt6-tools-dev-tools,
-               qt6-webengine-dev [amd64 arm64 armhf i386],
-               qt6-webengine-dev-tools [amd64 arm64 armhf i386],
 # daemon
                libdbus-1-dev,
                libdbus-c++-dev,
@@ -115,9 +111,7 @@
          qml6-module-qtquick-layouts,
          qml6-module-qtquick-shapes,
          qml6-module-qtquick-templates,
-         qml6-module-qtquick-window,
-         qml6-module-qtwebengine [amd64 arm64 armhf i386],
-         qml6-module-qtwebchannel [amd64 arm64 armhf i386]
+         qml6-module-qtquick-window
 Provides: jami-qt
 Description: Secure and distributed voice, video, and chat platform - desktop client
  Jami is an end-to-end encrypted secure and distributed voice, video,
diff --git a/debian/copyright b/debian/copyright
index 59cca73f..1ac996ad 100644
--- a/debian/copyright
+++ b/debian/copyright
@@ -30,6 +30,17 @@ Files-Excluded: daemon/contrib/tarballs/argon2*
                 daemon/contrib/tarballs/x264*
                 daemon/contrib/tarballs/yaml-cpp*
                 daemon/contrib/tarballs/zlib*
+                src/app/webengine/*
+                src/app/previewengine.cpp
+                src/libclient/web-chatview/*
+                src/libclient/webresources.qrc
+Comment: Reasons for above exclusions:
+ The daemon/contrib/tarballs exclusions are for dependencies bundled
+ in release tarballs by upstream that are already packaged in Debian,
+ with the exception of pjproject which we keep (more details below).
+ The web-related exclusions are for omitting web-related files, some
+ of which minified JavaScript, since we build without Qt WebEngine,
+ and thus do not need those files.
 
 
 Files: *
diff --git a/debian/rules b/debian/rules
index 08ae06aa..41170fc2 100755
--- a/debian/rules
+++ b/debian/rules
@@ -19,13 +19,6 @@ ifeq ($(NO_CPUS),0)
 NO_CPUS=1
 endif
 
-# Build with Qt WebEngine on supported arches
-ifneq (,$(filter $(DEB_HOST_ARCH), amd64 arm64 armhf i386))
-webengine := true
-else
-webengine := false
-endif
-
 %:
 	dh $@ --without autoreconf
 
@@ -88,17 +81,15 @@ endif
 	    --disable-shared
 
 # Qt client configure
-ifeq (,$(filter $(DEB_HOST_ARCH), amd64 arm64 armhf i386))
 # Stopgap workaround to disable building with Qt WebEngine
 	sed -i 's/set(WITH_WEBENGINE true)/#&/' CMakeLists.txt
-endif
 	mkdir build
 	cd build && \
 	  cmake \
 	    -DCMAKE_INSTALL_PREFIX=/usr \
 	    -DCMAKE_BUILD_TYPE=Release \
 	    -DWITH_DAEMON_SUBMODULE=true \
-	    -DWITH_WEBENGINE=$(webengine) \
+	    -DWITH_WEBENGINE=false \
 	    ..
 
 	dh_auto_configure
diff --git a/debian/source/lintian-overrides b/debian/source/lintian-overrides
index 30d220df..c699956a 100644
--- a/debian/source/lintian-overrides
+++ b/debian/source/lintian-overrides
@@ -1,4 +1 @@
-# The full commented source is there.
-source-is-missing [src/libclient/web-chatview/linkify.js]
-source-is-missing [src/libclient/web-chatview/jed.js]
 source-is-missing [3rdparty/SortFilterProxyModel/docs/*.html]
-- 
GitLab

